<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>pthread下互斥锁与自旋锁 | Tyxxzjpdez&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="本文主要从源码角度探讨工业级别的互斥锁与自旋锁的具体设计。 互斥锁pthread_mutex_lock 此处为了便于理解，仅仅展示伪代码（下图来自《Linux环境编程：从应用到内核》P307）  核心思想  维护一个原子量，多线程共享该值，且该值初始化为0  该值为0表示互斥量没有上锁，进入之后立即返回即可 该值为1表示现在互斥量已经上锁，但是没有线程正在等待 该值为2表示互斥量已经上锁，并且有线">
<meta property="og:type" content="article">
<meta property="og:title" content="pthread下互斥锁与自旋锁">
<meta property="og:url" content="http://tyxxzjpdez.github.io/newblog/2021/10/08/pthread%E4%B8%8B%E4%BA%92%E6%96%A5%E9%94%81%E4%B8%8E%E8%87%AA%E6%97%8B%E9%94%81/index.html">
<meta property="og:site_name" content="Tyxxzjpdez&#39;s Blog">
<meta property="og:description" content="本文主要从源码角度探讨工业级别的互斥锁与自旋锁的具体设计。 互斥锁pthread_mutex_lock 此处为了便于理解，仅仅展示伪代码（下图来自《Linux环境编程：从应用到内核》P307）  核心思想  维护一个原子量，多线程共享该值，且该值初始化为0  该值为0表示互斥量没有上锁，进入之后立即返回即可 该值为1表示现在互斥量已经上锁，但是没有线程正在等待 该值为2表示互斥量已经上锁，并且有线">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://s3.bmp.ovh/imgs/2021/10/6f5da7efe7cd7f94.png">
<meta property="article:published_time" content="2021-10-08T19:09:22.000Z">
<meta property="article:modified_time" content="2021-10-08T13:07:49.201Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="multi-thread">
<meta property="article:tag" content="linux">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s3.bmp.ovh/imgs/2021/10/6f5da7efe7cd7f94.png">
  
    <link rel="alternate" href="/newblog/atom.xml" title="Tyxxzjpdez's Blog" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/newblog/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/newblog/css/style.css">

  
    
<link rel="stylesheet" href="/newblog/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/newblog/" id="logo">Tyxxzjpdez&#39;s Blog</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/newblog/">Home</a>
        
          <a class="main-nav-link" href="/newblog/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/newblog/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://tyxxzjpdez.github.io/newblog"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-pthread下互斥锁与自旋锁" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/newblog/2021/10/08/pthread%E4%B8%8B%E4%BA%92%E6%96%A5%E9%94%81%E4%B8%8E%E8%87%AA%E6%97%8B%E9%94%81/" class="article-date">
  <time class="dt-published" datetime="2021-10-08T19:09:22.000Z" itemprop="datePublished">2021-10-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="p-name article-title" itemprop="headline name">
      pthread下互斥锁与自旋锁
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>本文主要从源码角度探讨工业级别的互斥锁与自旋锁的具体设计。</p>
<h2 id="互斥锁pthread-mutex-lock">互斥锁pthread_mutex_lock</h2>
<p>此处为了便于理解，仅仅展示伪代码（下图来自《Linux环境编程：从应用到内核》P307）</p>
<img src="https://s3.bmp.ovh/imgs/2021/10/6f5da7efe7cd7f94.png"  />
<h3 id="核心思想">核心思想</h3>
<ul>
<li>维护一个原子量，多线程共享该值，且该值初始化为0
<ul>
<li>该值为0表示互斥量没有上锁，进入之后立即返回即可</li>
<li>该值为1表示现在互斥量已经上锁，但是没有线程正在等待</li>
<li>该值为2表示互斥量已经上锁，并且有线程在等待该锁</li>
</ul>
</li>
<li>当发现互斥量为1时不要直接睡眠，而是在while循环中自旋地询问该值，只要该值为0，便立马继续下去</li>
<li>只有当互斥量为2时才会直接考虑睡眠</li>
</ul>
<h3 id="实现优点">实现优点</h3>
<p>该方法最大的优点是当争抢不严重的时候，并不需要陷入内核，退化为了一个自旋锁，提高了效率。</p>
<h2 id="自旋锁pthread-spin-lock">自旋锁pthread_spin_lock</h2>
<p>这里的源码就很简单了。</p>
<h3 id="环境：">环境：</h3>
<ul>
<li>
<p>ubuntu18.04LTS x86_64</p>
</li>
<li>
<p>gcc 版本11.1.0</p>
</li>
<li>
<p>glibc 版本 2.17</p>
</li>
</ul>
<h3 id="pthread-spin-lock">pthread_spin_lock</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">0x0000000000404d80 &lt;+0&gt;:	lock decl (%rdi)</span><br><span class="line">0x0000000000404d83 &lt;+3&gt;:	jne    0x404d90 &lt;pthread_spin_lock+16&gt;</span><br><span class="line">0x0000000000404d85 &lt;+5&gt;:	xor    %eax,%eax</span><br><span class="line">0x0000000000404d87 &lt;+7&gt;:	ret    </span><br><span class="line">0x0000000000404d88 &lt;+8&gt;:	nopl   0x0(%rax,%rax,1)</span><br><span class="line">0x0000000000404d90 &lt;+16&gt;:	pause  </span><br><span class="line">0x0000000000404d92 &lt;+18&gt;:	cmpl   $0x0,(%rdi)</span><br><span class="line">0x0000000000404d95 &lt;+21&gt;:	jg     0x404d80 &lt;pthread_spin_lock&gt;</span><br><span class="line">0x0000000000404d97 &lt;+23&gt;:	jmp    0x404d90 &lt;pthread_spin_lock+16&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="pthread-spin-unlock">pthread_spin_unlock</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">0x0000000000404da0 &lt;+0&gt;:	movl   $0x1,(%rdi)</span><br><span class="line">0x0000000000404da6 &lt;+6&gt;:	xor    %eax,%eax</span><br><span class="line">0x0000000000404da8 &lt;+8&gt;:	ret </span><br></pre></td></tr></table></figure>
<h3 id="分析">分析</h3>
<p>逻辑上其实很简单，自旋加锁循环查看原子量是否为0，而解锁直接将该原子量递增即可。比较有意思的是加锁部分</p>
<ul>
<li>lock是RMW操作，逻辑上可以认为锁住该cacheline的总线，原子修改该内存值，并且具有双向内存屏障的作用。</li>
<li>在spin_lock函数中为什么需要pause指令，它有什么功能？<sup class="footnote-ref"><a href="#fn1" id="fnref1">[1]</a></sup><sup class="footnote-ref"><a href="#fn2" id="fnref2">[2]</a></sup>
<ul>
<li>首先需要明确虽然x86拥有强的内存模型，仅允许很少的乱序重排。但是为了提高性能，在具体实现上，CPU实际上依旧可能是有先后顺序的，但是在执行之后，CPU会做一个检测，如果满足则继续，但是如果不满足，就会产生一个<code>memory ordering violation</code>，就需要重新改变流水线再重新执行，这就大大降低了CPU执行的性能。</li>
<li>在spin_lock中可能需要持续读取其他cpu上的共享变量，这时为了保证本地CPU察觉到这种改变，可能就经常会发生<code>memory ordering violation</code>，所以经常打断原本的流水线，大大降低CPU执行速度。</li>
<li>另外一般spin_lock并不需要过高的时间粒度，过高的CPU占用率可能反而是只是浪费能源。</li>
<li>综合以上两点，pause的基本功能是让CPU休眠几个时钟周期后再被唤醒，不仅不会过于频繁地发生读取从而导致<code>memory ordering violation</code>，而且休眠也能降低功耗。</li>
</ul>
</li>
<li>为什么spin_lock需要加上LOCK前缀，而spin_unlock却不需要？<sup class="footnote-ref"><a href="#fn3" id="fnref3">[3]</a></sup>
<ul>
<li>使用spin_unlock的时候已经离开临界区了，而且本身是一个函数，开头的第一个指令一般不可能与前面的指令发生重排，而且考虑到<code>movl   $0x1,(%rdi)</code>是一个store操作，我们根本不关注它本身是否会推迟，那根本无所谓，因为无论如何都依旧符合store release的语义。</li>
<li>而使用spin_lock的时候才刚开始临界区，需要满足load acquire的语义，不希望该原子量后面的指令跑到前面去，所以需要使用LOCK指令。</li>
</ul>
</li>
</ul>
<h2 id="参考">参考</h2>
<hr class="footnotes-sep">
<section class="footnotes">
<ol class="footnotes-list">
<li id="fn1" class="footnote-item"><p><a target="_blank" rel="noopener" href="https://kb.cnblogs.com/page/105657/">自旋锁spinlock剖析与改进</a> <a href="#fnref1" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn2" class="footnote-item"><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/55563077/why-flush-the-pipeline-for-memory-order-violation-caused-by-other-logical-proces">Why flush the pipeline for Memory Order Violation caused by other logical processors?</a> <a href="#fnref2" class="footnote-backref">↩︎</a></p>
</li>
<li id="fn3" class="footnote-item"><p><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/68090562/how-come-spin-unlock-does-not-need-to-flush-store-buffer-on-x86-amd64">How come spin-unlock does not need to flush store buffer on x86/amd64 </a> <a href="#fnref3" class="footnote-backref">↩︎</a></p>
</li>
</ol>
</section>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://tyxxzjpdez.github.io/newblog/2021/10/08/pthread%E4%B8%8B%E4%BA%92%E6%96%A5%E9%94%81%E4%B8%8E%E8%87%AA%E6%97%8B%E9%94%81/" data-id="ckuidw91c00071e1fczqi56s5" data-title="pthread下互斥锁与自旋锁" class="article-share-link">Share</a>
      
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/newblog/tags/linux/" rel="tag">linux</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/newblog/tags/multi-thread/" rel="tag">multi-thread</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
  
    <a href="/newblog/2021/09/19/%E8%BF%9B%E7%A8%8B%E8%B0%83%E5%BA%A6/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">Linux的进程调度</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/newblog/tags/C/" rel="tag">C++</a></li><li class="tag-list-item"><a class="tag-list-link" href="/newblog/tags/Linux/" rel="tag">Linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/newblog/tags/SMP/" rel="tag">SMP</a></li><li class="tag-list-item"><a class="tag-list-link" href="/newblog/tags/coroutine/" rel="tag">coroutine</a></li><li class="tag-list-item"><a class="tag-list-link" href="/newblog/tags/debug/" rel="tag">debug</a></li><li class="tag-list-item"><a class="tag-list-link" href="/newblog/tags/linux/" rel="tag">linux</a></li><li class="tag-list-item"><a class="tag-list-link" href="/newblog/tags/multi-thread/" rel="tag">multi-thread</a></li><li class="tag-list-item"><a class="tag-list-link" href="/newblog/tags/notes/" rel="tag">notes</a></li><li class="tag-list-item"><a class="tag-list-link" href="/newblog/tags/process/" rel="tag">process</a></li><li class="tag-list-item"><a class="tag-list-link" href="/newblog/tags/roast/" rel="tag">roast</a></li><li class="tag-list-item"><a class="tag-list-link" href="/newblog/tags/shell/" rel="tag">shell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/newblog/tags/thread/" rel="tag">thread</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/newblog/tags/C/" style="font-size: 15px;">C++</a> <a href="/newblog/tags/Linux/" style="font-size: 20px;">Linux</a> <a href="/newblog/tags/SMP/" style="font-size: 10px;">SMP</a> <a href="/newblog/tags/coroutine/" style="font-size: 10px;">coroutine</a> <a href="/newblog/tags/debug/" style="font-size: 10px;">debug</a> <a href="/newblog/tags/linux/" style="font-size: 10px;">linux</a> <a href="/newblog/tags/multi-thread/" style="font-size: 15px;">multi-thread</a> <a href="/newblog/tags/notes/" style="font-size: 10px;">notes</a> <a href="/newblog/tags/process/" style="font-size: 10px;">process</a> <a href="/newblog/tags/roast/" style="font-size: 15px;">roast</a> <a href="/newblog/tags/shell/" style="font-size: 10px;">shell</a> <a href="/newblog/tags/thread/" style="font-size: 10px;">thread</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/newblog/archives/2021/10/">October 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/newblog/archives/2021/09/">September 2021</a></li><li class="archive-list-item"><a class="archive-list-link" href="/newblog/archives/2021/08/">August 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/newblog/2021/10/08/pthread%E4%B8%8B%E4%BA%92%E6%96%A5%E9%94%81%E4%B8%8E%E8%87%AA%E6%97%8B%E9%94%81/">pthread下互斥锁与自旋锁</a>
          </li>
        
          <li>
            <a href="/newblog/2021/09/19/%E8%BF%9B%E7%A8%8B%E8%B0%83%E5%BA%A6/">Linux的进程调度</a>
          </li>
        
          <li>
            <a href="/newblog/2021/09/09/%E5%A4%9A%E6%A0%B8%E7%BC%96%E7%A8%8B/">多核编程</a>
          </li>
        
          <li>
            <a href="/newblog/2021/09/09/gdb%E5%B8%B8%E7%94%A8%E8%B0%83%E8%AF%95%E6%8C%87%E4%BB%A4/">gdb常用调试指令</a>
          </li>
        
          <li>
            <a href="/newblog/2021/09/05/%E5%B0%8F%E7%82%B9%E9%9B%86%E9%94%A6/">小点集锦</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/newblog/" class="mobile-nav-link">Home</a>
  
    <a href="/newblog/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/newblog/js/jquery-3.4.1.min.js"></script>



  
<script src="/newblog/fancybox/jquery.fancybox.min.js"></script>




<script src="/newblog/js/script.js"></script>





  </div>
</body>
</html>